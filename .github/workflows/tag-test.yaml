name: Tag test

on:
  push:
    tags:
      - v*

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set up variables
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            
            const refRes = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tag}`,
            });

            const { object } = refRes.data; // { sha, type, url }

            let tagMessage = '';
            if (object.type === 'tag') {
              const tagObj = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_sha: object.sha,
              });
              tagMessage = (tagObj.data.message || '').trim();
            } else {
              // Lightweight tag
              tagMessage = '';
            }

            const isPreRelease = tagMessage.toLowerCase() === 'prerelease' || tagMessage.toLowerCase() === 'preview';

            core.exportVariable('TAG_NAME', tag);
            core.exportVariable('IS_PRERELEASE', String(isPreRelease));
            core.info(`TAG_NAME=${tag}, IS_PRERELEASE=${isPreRelease}, type=${object.type}, msg="${tagMessage}"`);
